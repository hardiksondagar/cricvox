---
description: AI Cricket Commentary Engine (CricVox) — full project architecture, design decisions, and conventions
alwaysApply: true
---

# AI Cricket Commentary Engine (CricVox) — Project Reference

## Overview

Real-time AI cricket commentary engine that replays T20 match ball-by-ball with LLM-generated commentary and TTS audio. Built with Python 3.11+, FastAPI, OpenAI GPT-4.1, and multi-vendor TTS (ElevenLabs, Sarvam, OpenAI).

## Tech Stack

- **Backend**: FastAPI + Uvicorn (async)
- **LLM**: OpenAI GPT-4.1 (ball commentary + narrative moments)
- **TTS**: ElevenLabs v3, Sarvam Bulbul v3, OpenAI gpt-4o-mini-tts
- **Frontend**: Vanilla HTML/CSS/JS + Tailwind CDN, polling-based updates
- **Database**: SQLite via aiosqlite (normalized schema)
- **Testing**: pytest + pytest-asyncio (38 tests)
- **Config**: pydantic-settings with `.env`

## Terminology

- **batter** (not batsman) — gender-neutral
- **deliveries** (not balls) — cricket standard for the DB/API layer

## File Structure

```
app/
  main.py              — FastAPI app, all REST API endpoints
  config.py            — Settings (API keys, delays) via pydantic-settings
  models.py            — All Pydantic models (BallEvent, MatchState, BatterStats, BowlerStats, etc.)
  generate.py          — Offline generation pipeline (LLM + TTS per language)
  engine/
    state_manager.py   — Ball-by-ball state tracking (score, batters, bowlers, partnerships, FOW)
    logic_engine.py    — NarrativeBranch classification, selective context notes for LLM
    pivot_detector.py  — Pivot/equation-shift moment detection
    precompute.py      — Deterministic state precomputation (state + logic + narratives)
  commentary/
    prompts.py         — SYSTEM_PROMPT, USER_PROMPT_TEMPLATE, NARRATIVE_SYSTEM_PROMPT, all templates
    generator.py       — OpenAI GPT-4.1 commentary + narrative generation
  audio/
    tts.py             — TTS facade — routes to provider based on language config
    elevenlabs.py      — ElevenLabs v3 provider
    sarvam.py          — Sarvam Bulbul v3 provider
    openai_tts.py      — OpenAI gpt-4o-mini-tts provider
    phonetics.py       — Player name pronunciation helpers
  storage/
    database.py        — SQLite schema, all CRUD, migrations
    audio.py           — Content-hashed MP3 file storage + deduplication
scripts/
  load_match.py        — Loads JSON match data into DB via API endpoints
data/
  languages.json       — Language configs (code, name, tts_vendor, voice_id, etc.)
  matches.db           — SQLite database (gitignored)
  sample/
    ind_vs_sa_final.json — T20 World Cup 2024 Final ball-by-ball data
tests/
  conftest.py          — Shared fixtures (per-test SQLite, AsyncClient, seed data)
  test_database.py     — 14 database CRUD unit tests
  test_api.py          — 13 API integration tests
  test_engine.py       — 11 engine unit tests (StateManager, LogicEngine, precompute)
static/
  index.html           — SPA dashboard (Tailwind CSS, dark theme)
  app.js               — Polling client, audio queue, scoreboard, timeline progress bar
  style.css            — Dark theme styles
```

## Database Schema (normalized)

- **matches**: match_id, title, status, match_info (JSON), languages (JSON), venue, format, team1, team2, match_date, created_at
- **deliveries**: id, match_id, innings, ball_index, over, ball, batter, bowler, non_batter, batter_id, non_batter_id, bowler_id, runs, extras, extras_type, is_wicket, is_boundary, is_six, total_runs, total_wickets, overs_completed, balls_in_over, crr, rrr, runs_needed, balls_remaining, match_phase, data (JSON), context (JSON)
- **match_commentaries**: id, match_id, ball_id (FK), seq, event_type, language, text, audio_url, data (JSON), created_at
- **innings_batters**: match_id, innings, name, position, runs, balls_faced, fours, sixes, dots, is_out, strike_rate, out_status, dismissal_info
- **innings_bowlers**: match_id, innings, name, balls_bowled, runs_conceded, wickets, maidens, dots, economy, overs_bowled
- **fall_of_wickets**: match_id, innings, wicket_number, batter, batter_runs, team_score, overs, bowler, how
- **innings**: match_id, innings_number, batting_team, bowling_team, total_runs, total_wickets, total_overs, extras_total
- **partnerships**: match_id, innings, wicket_number, batter1, batter2, runs, balls

## Core Architecture

### Pipeline Flow
```
JSON feed → scripts/load_match.py → API endpoints → SQLite
  → precompute (state + logic + narratives) auto on insertion
  → generate (LLM commentary × N languages + TTS × N languages)
  → store commentaries → frontend polls + plays audio
```

### StateManager (`engine/state_manager.py`)

Tracks everything a commentator would know:
- Score, overs, run rates (CRR, RRR)
- Per-batter: runs, balls, 4s, 6s, dots, dot%, strike rate, position, milestones
- Per-bowler: balls, runs, wickets, maidens, dots, dot%, fours/sixes conceded, wides, noballs, economy
- Partnership: runs, balls, partnership number (resets on wicket)
- Fall of wickets: batter, score, team total, overs, how
- Over-by-over run history → phase runs (PP/middle/death), run rate windows
- Transition flags: is_new_bowler, is_new_over, is_strike_change, is_new_batter

### LogicEngine (`engine/logic_engine.py`)

- Classifies each delivery: ROUTINE, BOUNDARY_MOMENTUM, WICKET_DRAMA, PRESSURE_BUILDER, OVER_TRANSITION, EXTRA_GIFT
- Builds **selective** context notes — NOT everything every ball
- On wickets: ONLY dismissal info, FOW, collapse. NO dots/pressure/boundary drought.

### Precompute (`engine/precompute.py`)

- Runs StateManager + LogicEngine over deliveries, stores context in `deliveries.context`
- Also populates: `innings_batters`, `innings_bowlers`, `fall_of_wickets`, `innings`, `partnerships`
- Auto-triggered on delivery insertion (single or bulk)

### API Endpoints

**Matches:** POST create, GET list/detail, PATCH update, DELETE (cascades)
**Deliveries:** POST single (auto-precomputes), POST bulk, GET list/detail
**Innings Stats:** GET summary, batters, bowlers, fall-of-wickets, partnerships, innings records
**Commentaries:** GET poll, GET single, DELETE all
**Generation:** POST match text (background), POST single text, POST match audio (background), POST single audio
**Other:** GET timeline, GET languages, GET `/api/matches/{id}/full` (everything in one call)

### Narrative Moments

| Moment | When |
|--------|------|
| `first_innings_start` | Before any ball (start_over=1 only) |
| `first_innings_end` | After 1st innings |
| `second_innings_start` | Before chase begins |
| `end_of_over` | After every completed over |
| `new_batter` | After every wicket |
| `phase_change` | PP→Middle, Middle→Death |
| `milestone` | Batter reaches 50/100 |
| `match_result` | Match ends |

## Key Design Decisions

1. **LLM gets bare facts only** — no shot descriptions. Infers context from stats.
2. **Context is selective** — logic engine surfaces what matters for THIS delivery.
3. **Wicket = only story** — on wickets, all momentum/dot/boundary noise suppressed.
4. **Commentary history** — last 5 lines sent to LLM to prevent repetition.
5. **Precompute on insert** — context computed when delivery added, not as separate step.
6. **Normalized schema** — key fields promoted from JSON, stats in dedicated tables.
7. **Gender-neutral terminology** — `batter` not batsman, `deliveries` not balls.
8. **Everything is an API** — data loading uses the same endpoints as UI/CLI.

## Testing

```bash
python -m pytest tests/ -v         # 38 tests, ~0.7s
```

- `test_database.py` — 14 CRUD unit tests (all tables)
- `test_api.py` — 13 integration tests (all endpoints)
- `test_engine.py` — 11 engine tests (StateManager, LogicEngine, precompute)

Fixtures: per-test isolated SQLite (tmp_path), AsyncClient via ASGITransport, seeded match data.
