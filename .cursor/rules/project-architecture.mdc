---
description: AI Cricket Commentary Engine — full project architecture, design decisions, and conventions
alwaysApply: true
---

# AI Cricket Commentary Engine — Project Reference

## Overview

Real-time AI cricket commentary engine that replays T20 match ball-by-ball with LLM-generated commentary and TTS audio. Built with Python 3.11+, FastAPI, OpenAI GPT-4o-mini, and ElevenLabs v3 TTS.

## Tech Stack

- **Backend**: FastAPI + Uvicorn (async)
- **LLM**: OpenAI GPT-4o-mini (ball commentary + narrative moments)
- **TTS**: ElevenLabs v3 (`eleven_v3` model, stability: 0.0/0.5/1.0)
- **Frontend**: Vanilla HTML/CSS/JS with SSE for real-time updates
- **Config**: pydantic-settings with `.env`

## File Structure

```
app/
  main.py              — FastAPI app, match loop, SSE broadcast, narrative injection
  config.py            — Settings (API keys, delays) via pydantic-settings
  models.py            — All Pydantic models (BallEvent, MatchState, BatsmanStats, BowlerStats, etc.)
  engine/
    state_manager.py   — Ball-by-ball state tracking (score, partnerships, FOW, bowler/batsman stats)
    logic_engine.py    — Classifies NarrativeBranch, builds selective context notes for LLM
    pivot_detector.py  — Detects pivot/equation-shift moments
  commentary/
    prompts.py         — SYSTEM_PROMPT, USER_PROMPT_TEMPLATE, NARRATIVE_SYSTEM_PROMPT, all templates
    generator.py       — generate_commentary() for balls, generate_narrative() for moments
  audio/
    tts.py             — ElevenLabs v3 TTS with stability mapped to NarrativeBranch
    phonetics.py       — Player name pronunciation helpers
  feed/
    mock_feed.py       — Loads JSON match data, computes first innings summary
    ind_vs_sa_final.json — T20 World Cup 2024 Final match data
static/
  index.html           — Dashboard UI
  app.js               — SSE client, audio queue, scoreboard updates
  style.css            — Dark theme UI styles
```

## Core Architecture

### Match Loop (`main.py::_run_match`)

1. **Fast-forward** — silently process balls before `start_over` through StateManager (no LLM/TTS)
2. **Pre-match narratives** (only when start_over=1):
   - `first_innings_start` → `first_innings_end` → `second_innings_start`
3. **Ball-by-ball loop** — for each ball:
   - StateManager.update(ball) → LogicEngine.analyze() → generate_commentary() → synthesize_speech() → broadcast SSE
4. **Post-ball narrative triggers** (in order):
   - Milestone (50/100) → New Batsman (after wicket) → End of Over / Phase Change
5. **Match result** — `match_result` narrative at the end

When `start_over > 1`: skip all narratives, just send score_update to sync frontend, start ball loop.

### StateManager (`engine/state_manager.py`)

Tracks everything a commentator would know from THIS match:
- Score, overs, run rates (CRR, RRR)
- Per-batsman: runs, balls, 4s, 6s, dots, dot%, strike rate, position, milestones
- Per-bowler: balls, runs, wickets, maidens, dots, dot%, fours/sixes conceded, wides, noballs, economy
- Partnership: runs, balls, partnership number (1st/2nd/etc.)
- Fall of wickets log: batsman, score, team total, overs, how
- Over-by-over run history → phase runs (PP/middle/death), run rate windows (last 3/5 overs)
- Boundary drought: balls_since_last_boundary, is_boundary_drought (18+ balls)
- Wicket proximity: balls_since_last_wicket, is_collapse (3+ in 18 balls)
- Total boundaries, extras breakdown (wides, noballs)
- Scoring momentum: accelerating/decelerating/steady
- Batting order, commentary history (last 6 lines)
- Transition flags: is_new_bowler, is_new_over, is_strike_change, is_new_batsman

### LogicEngine (`engine/logic_engine.py`)

- Classifies each ball into NarrativeBranch: ROUTINE, BOUNDARY_MOMENTUM, WICKET_DRAMA, PRESSURE_BUILDER, OVER_TRANSITION, EXTRA_GIFT
- Builds **selective** context notes — NOT everything every ball:
  - On wickets: ONLY dismissal info, FOW, collapse, partnership broken. NO dots/pressure/boundary drought.
  - Sections 7-8 (momentum, innings stats) are gated with `if not ball.is_wicket`
  - Boundary drought only after 12+ balls, flagged at 18+
  - Dot% only when high and batsman has 10+ balls
  - Phase summary only at transitions

### Commentary Prompts (`commentary/prompts.py`)

- **SYSTEM_PROMPT**: Core principle = LLM gets ONLY bare score data, must NOT invent shots/deliveries/fielding
- **CONTEXT RULES**: Phase-by-phase rules (PP, middle, death) for when to mention pressure, RRR, etc.
- **REPETITION RULES**: LLM sees last 5 commentary lines and must not repeat phrases
- **USER_PROMPT_TEMPLATE**: Score line with CRR+RRR, ball event, branch, context notes, recent commentary
- **NARRATIVE_SYSTEM_PROMPT + NARRATIVE_PROMPTS**: 8 distinct narrative moment templates

### Narrative Moments

| Moment | When | Notes |
|--------|------|-------|
| `first_innings_start` | Before any ball (start_over=1 only) | Scene-setting, venue, teams |
| `first_innings_end` | After 1st innings start | Top scorers/bowlers computed from innings 1 data |
| `second_innings_start` | Before chase begins (start_over=1 only) | Target, challenge ahead |
| `end_of_over` | After every completed over | Over summary, bowler figures |
| `new_batsman` | After every wicket | Situation they walk into |
| `phase_change` | PP→Middle, Middle→Death | Replaces end_of_over |
| `milestone` | Batsman reaches 50/100 | Celebration |
| `match_result` | Match ends | Final result, highlights |

### TTS (`audio/tts.py`)

ElevenLabs v3 with discrete stability:
- 0.0 (Creative) — wickets, boundaries, pivots
- 0.5 (Natural) — pressure, over transitions
- 1.0 (Robust) — routine balls

### API Endpoints

- `POST /api/start?start_over=N` — start from over N (1-indexed, default 1)
- `POST /api/stop` — stop replay
- `GET /api/stream` — SSE stream (events: match_start, score_update, commentary, match_end)
- `GET /api/status` — is match running?
- `GET /api/match-info` — match metadata

## Key Design Decisions

1. **LLM gets bare facts only** — no shot descriptions, no delivery types. It infers context from stats.
2. **Context is selective** — logic engine surfaces what matters for THIS ball, not everything.
3. **Wicket = only story** — on wicket balls, all momentum/dot/boundary noise is suppressed.
4. **Commentary history** — last 5 lines sent to LLM to prevent repetition and build narrative flow.
5. **Fast-forward for testing** — `start_over` silently builds state, no narratives when skipping ahead.
6. **Narrative moments are distinct** — first innings start ≠ second innings start ≠ match result.
7. **State is comprehensive** — everything a commentator would know from watching the match.

## Testing

From UI: set "From over" input (1-20), click Start Match.
- Over 1: full experience with all pre-match narratives
- Over 7: after powerplay
- Over 15: start of death overs
- Over 18+: deep pressure scenarios
